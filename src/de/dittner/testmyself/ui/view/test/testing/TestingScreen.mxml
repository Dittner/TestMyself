<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
         xmlns:s="library://ns.adobe.com/flex/spark"
         xmlns:test="de.dittner.testmyself.ui.view.test.testing.components.*"
         xmlns:utils="de.dittner.testmyself.ui.common.utils.*"
         xmlns:mp3="de.dittner.testmyself.ui.common.audio.mp3.*">

    <fx:Script><![CDATA[
        import de.dittner.async.IAsyncOperation;
        import de.dittner.testmyself.model.domain.test.Test;
        import de.dittner.testmyself.model.domain.test.TestID;
        import de.dittner.testmyself.ui.common.menu.IMenuBoard;
        import de.dittner.testmyself.ui.common.utils.AppColors;
        import de.dittner.testmyself.ui.common.utils.AppSizes;
        import de.dittner.testmyself.ui.common.utils.FontName;
        import de.dittner.testmyself.ui.view.test.TestVM;
        import de.dittner.testmyself.ui.view.test.common.TestingAction;
        import de.dittner.testmyself.ui.view.test.testing.components.TestableView;

        //--------------------------------------
        //  padding
        //--------------------------------------
        private var _padding:uint = 0;
        [Bindable("paddingChanged")]
        public function get padding():uint {return _padding;}
        public function set padding(value:uint):void {
            if (_padding != value) {
                _padding = value;
                dispatchEvent(new Event("paddingChanged"));
            }
        }

        //--------------------------------------
        //  vm
        //--------------------------------------
        private var _vm:TestVM;
        [Bindable("vmChanged")]
        public function get vm():TestVM {return _vm;}
        public function set vm(value:TestVM):void {
            if (_vm != value) {
                _vm = value;
                dispatchEvent(new Event("vmChanged"));
            }
        }

        //--------------------------------------
        //  errorsNum
        //--------------------------------------
        private var _errorsNum:int = 0;
        [Bindable("errorsNumChanged")]
        public function get errorsNum():int {return _errorsNum;}
        private function setErrorsNum(value:int):void {
            if (_errorsNum != value) {
                _errorsNum = value;
                dispatchEvent(new Event("errorsNumChanged"));
            }
        }

        //----------------------------------------------------------------------------------------------
        //
        //  Methods
        //
        //----------------------------------------------------------------------------------------------

        private var menu:IMenuBoard;
        public function activate(menu:IMenuBoard):void {
            this.menu = menu;
            setErrorsNum(0);
            findTestView(vm.testPage.test);
            activeTestView.activate(actionCallback, menu);
            activeTestView.visible = activeTestView.includeInLayout = true;
            loadTestTaskIDs();
        }

        public function deactivate():void {
            activeTestView.deactivate();
            activeTestView.visible = activeTestView.includeInLayout = false;
            vm.selectedTestTask = null;
        }

        private var activeTestView:TestableView;

        private function findTestView(test:Test):void {
            switch (test.id) {
                case TestID.SPEAK_WORD_TRANSLATION :
                    activeTestView = speakWordTranslationTest;
                    break;
                case TestID.SELECT_ARTICLE :
                    activeTestView = selectArticleTest;
                    break;
                case TestID.WRITE_WORD :
                case TestID.WRITE_VERB :
                case TestID.WRITE_LESSON :
                case TestID.WRITE_VERB_EXAMPLE :
                case TestID.WRITE_WORD_EXAMPLE :
                    activeTestView = writeNoteTest;
                    break;
                case TestID.SPEAK_LESSON_TRANSLATION :
                case TestID.SPEAK_VERB_EXAMPLE_TRANSLATION :
                case TestID.SPEAK_WORD_EXAMPLE_TRANSLATION :
                case TestID.SPEAK_WORD_IN_DEUTSCH :
                case TestID.SPEAK_LESSON_IN_DEUTSCH :
                case TestID.SPEAK_VERB_EXAMPLE_IN_DEUTSCH :
                case TestID.SPEAK_WORD_EXAMPLE_IN_DEUTSCH :
                    activeTestView = speakNoteTranslationTest;
                    break;
                case TestID.SPEAK_VERB_FORMS :
                    activeTestView = speakVerbFormsTest;
                    break;
                default:
                    throw new Error("No Test found with id: " + test.id);
            }
        }

        private function loadTestTaskIDs():void {
            var op:IAsyncOperation = vm.loadTaskIDsForTest();
            op.addCompleteCallback(taskIDsLoaded);
        }

        private function taskIDsLoaded(op:IAsyncOperation):void {
            if (op.isSuccess) {
                vm.loadNextTestTask();
            }
        }

        private function actionCallback(action:String):void {
            switch (action) {
                case TestingAction.CORRECT_ANSWER :
                    vm.selectedTestTask.isFailed = false;
                    vm.selectedTestTask.store();
                    break;
                case TestingAction.INCORRECT_ANSWER :
                    setErrorsNum(errorsNum + 1);
                    vm.selectedTestTask.isFailed = true;
                    vm.selectedTestTask.store();
                    break;
                case TestingAction.NEXT_TASK :
                    vm.loadNextTestTask();
                    break;
            }
        }
        ]]></fx:Script>

    <utils:BG width="100%" height="100%" color="{AppColors.WHITE}"/>

    <!--HEADER-->
    <s:Label text="{errorsNum + ' Fehler'}"
             right="{padding}" top="{padding}"
             textAlign="right"
             fontSize="20"
             maxDisplayedLines="1"
             mouseChildren="false" mouseEnabled="false"
             color="{AppColors.TEXT_LIGHT}"/>

    <s:Label text="{vm.curTaskNumber + '/' + vm.testTaskIDs.length}"
             fontFamily="{FontName.MYRIAD_COND}"
             fontWeight="bold"
             fontSize="20"
             mouseChildren="false" mouseEnabled="false"
             left="{padding}" top="{padding}"
             color="{AppColors.TEXT_LIGHT}"/>

    <!--BODY-->

    <s:Group width="100%" top="50" bottom="{AppSizes.EDITOR_FOOTER_HEIGHT + 20}">

        <test:SpeakWordTranslationTest id="speakWordTranslationTest"
                                       width="100%" height="100%"
                                       visible="false" includeInLayout="false"
                                       testTask="{vm.selectedTestTask}"
                                       padding="{padding}"/>

        <test:SelectArticleTest id="selectArticleTest"
                                width="100%" height="100%"
                                visible="false" includeInLayout="false"
                                testTask="{vm.selectedTestTask}"
                                padding="{padding}"/>

        <test:WriteNoteTest id="writeNoteTest"
                            width="100%" height="100%"
                            visible="false" includeInLayout="false"
                            mp3Player="{mp3Player}"
                            testTask="{vm.selectedTestTask}"
                            padding="{padding}"/>

        <test:SpeakNoteTranslationTest id="speakNoteTranslationTest"
                                       width="100%" height="100%"
                                       visible="false" includeInLayout="false"
                                       translateFromNativeIntoForeign="{vm.testPage.test.translateFromNativeIntoForeign}"
                                       testTask="{vm.selectedTestTask}"
                                       padding="{padding}"/>

        <test:SpeakVerbFormsTest id="speakVerbFormsTest"
                                 width="100%" height="100%"
                                 visible="false" includeInLayout="false"
                                 testTask="{vm.selectedTestTask}"
                                 padding="{padding}"/>

    </s:Group>

    <s:Label id="tagsLbl"
             text="{vm.selectedNoteTags}"
             height="20" bottom="{AppSizes.EDITOR_FOOTER_HEIGHT}"
             width="50%" paddingLeft="10" paddingRight="10"
             right="10" textAlign="right"
             fontSize="12" verticalAlign="middle"
             maxDisplayedLines="1"
             color="{AppColors.TEXT_BLACK}"/>

    <!--FOOTER-->

    <s:Group width="100%" bottom="0" height="{AppSizes.EDITOR_FOOTER_HEIGHT}">

        <utils:BG width="100%" height="100%" color="{AppColors.SCREEN_FOOTER_BG}"/>

        <mp3:MP3Player id="mp3Player"
                       width="350"
                       left="{padding - 10}"
                       verticalCenter="0"
                       removeRecordEnabled="false"
                       visible="{mp3Player.hasComment}"
                       comment="{vm.selectedTestTask.note.audioComment}"
                       skinClass="de.dittner.testmyself.ui.common.audio.skins.MP3PlayerSkin"/>

        <s:Label id="titleLbl"
                 text="{vm.selectedVocabulary.title.toUpperCase() + '. ' + vm.testPage.test.title}"
                 right="{padding}" textAlign="right"
                 fontSize="14" verticalCenter="0"
                 maxDisplayedLines="1"
                 color="{AppColors.TEXT_BLACK}"/>

    </s:Group>
</s:Group>

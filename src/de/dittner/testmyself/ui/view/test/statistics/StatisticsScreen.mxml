<?xml version="1.0"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
         xmlns:s="library://ns.adobe.com/flex/spark"
         xmlns:button="de.dittner.testmyself.ui.common.button.*"
         xmlns:navigation="de.dittner.testmyself.ui.view.noteList.components.pagination.*"
         xmlns:utils="de.dittner.testmyself.ui.common.utils.*"
         xmlns:list="de.dittner.testmyself.ui.common.list.*"
         xmlns:common="de.dittner.testmyself.ui.view.test.common.*"
         xmlns:common2="de.dittner.testmyself.ui.view.noteList.components.*">
    <fx:Metadata>
        [Event(name="goBack", type="flash.events.Event")]
    </fx:Metadata>

    <fx:Script><![CDATA[
        import de.dittner.testmyself.model.domain.test.TestTask;
        import de.dittner.testmyself.ui.common.utils.AppColors;
        import de.dittner.testmyself.ui.common.utils.AppSizes;
        import de.dittner.testmyself.ui.view.test.TestVM;

        //--------------------------------------
        //  padding
        //--------------------------------------
        private var _padding:uint = 0;
        [Bindable("paddingChanged")]
        public function get padding():uint {return _padding;}
        public function set padding(value:uint):void {
            if (_padding != value) {
                _padding = value;
                dispatchEvent(new Event("paddingChanged"));
            }
        }

        //--------------------------------------
        //  vm
        //--------------------------------------
        private var _vm:TestVM;
        [Bindable("vmChanged")]
        public function get vm():TestVM {return _vm;}
        public function set vm(value:TestVM):void {
            if (_vm != value) {
                _vm = value;
                dispatchEvent(new Event("vmChanged"));
            }
        }

        //----------------------------------------------------------------------------------------------
        //
        //  Methods
        //
        //----------------------------------------------------------------------------------------------
        private var needTranslationInvert:Boolean = false;

        public function activate():void {
            vm.statisticsPage.number = 0;
            vm.statisticsPage.countAllNotes = true;
            vm.loadStatisticsPage();
        }

        private function setTaskAsRightBtnEnabled(selectedTask:*, isFailedTaskShown:Boolean):Boolean {
            return selectedTask && isFailedTaskShown;
        }

        private function goBack():void {
            dispatchEvent(new Event("goBack"));
        }

        private function setTaskAsRightBtnClickHandler(event:MouseEvent):void {
            var task:TestTask = list.selectedItem as TestTask;
            task.isFailed = false;
            task.store();
            if (showOnlyFailedNotesFilterBox.selected)
                vm.loadStatisticsPage();
        }

        private function pageNumChanged():void {
            vm.loadStatisticsPage();
        }

        private function showOnlyFailedTestTask():void {
            if (vm.statisticsPage.loadOnlyFailedTestTask != showOnlyFailedNotesFilterBox.selected) {
                vm.statisticsPage.loadOnlyFailedTestTask = showOnlyFailedNotesFilterBox.selected;
                vm.statisticsPage.number = 0;
                vm.statisticsPage.countAllNotes = true;
                vm.loadStatisticsPage();
            }
        }
        ]]></fx:Script>

    <utils:BG width="100%" height="100%" color="#ffFFff"/>

    <common:TestHeader width="100%" padding="{padding}"
                       title="{vm.statisticsPage.test.title}"/>

    <button:WhiteButton id="setTaskAsRightBtn"
                        horizontalCenter="-110" top="5"
                        label="Als richtig zeichnen"
                        width="220"
                        enabled="{setTaskAsRightBtnEnabled(list.selectedItem, showOnlyFailedNotesFilterBox.selected)}"
                        click="setTaskAsRightBtnClickHandler"/>

    <s:CheckBox id="showOnlyFailedNotesFilterBox"
                right="25" top="10"
                selected="{vm.statisticsPage.loadOnlyFailedTestTask}"
                skinClass="de.dittner.testmyself.ui.common.checkBox.DarkCheckBoxSkin"
                label="nur Notiz mit Fehlern"
                change="showOnlyFailedTestTask()"/>

    <s:HGroup left="-1" right="-1" top="39" bottom="{AppSizes.EDITOR_FOOTER_HEIGHT}" gap="-1">
        <s:Scroller width="100%" height="100%"
                    minViewportInset="1"
                    horizontalScrollPolicy="off"
                    hasFocusableChildren="false">

            <list:SelectableDataGroup id="list"
                                      selectedItem="{vm.selectedTestTask}"
                                      dataProvider="{vm.statisticsPage.taskColl}"
                                      width="100%"
                                      deselectEnabled="true"
                                      itemRenderer="de.dittner.testmyself.ui.view.test.statistics.StatisticsTaskRenderer"
                                      selectedItemChange="vm.selectedTestTask = list.selectedItem as TestTask">
                <list:layout>
                    <s:VerticalLayout gap="0" useVirtualLayout="false"/>
                </list:layout>
            </list:SelectableDataGroup>
        </s:Scroller>

        <common2:ExampleList id="exampleList"
                             width="100%" height="100%"
                             dataProvider="{vm.selectedTestTask.note.exampleColl}"
                             selectedNote="@{vm.selectedNoteExample}"
                             visible="{vm.statisticsPage.test.loadExamplesWhenTesting}"
                             includeInLayout="{vm.statisticsPage.test.loadExamplesWhenTesting}"
                             showTitle="false"
                             hasFocusableChildren="false"/>
    </s:HGroup>

    <s:Group width="100%" bottom="0" height="{AppSizes.EDITOR_FOOTER_HEIGHT}">

        <utils:BG width="100%" height="100%" color="{AppColors.SCREEN_HEADER_BG}"/>

        <navigation:PaginationBar id="paginationBar"
                                  left="{padding}" right="{padding}"
                                  height="100%"
                                  allNotesAmount="{vm.statisticsPage.amountAllTasks}"
                                  notesOnCurPage="{vm.statisticsPage.taskColl.length}"
                                  pageSize="{vm.statisticsPage.size}"
                                  pageNum="@{vm.statisticsPage.number}"
                                  pageNumChanged="pageNumChanged()"/>

        <button:GrayButton id="goBackBtn"
                           width="250"
                           verticalCenter="0"
                           left="{padding}"
                           label="ZurÃ¼ck"
                           click="goBack()"/>

    </s:Group>
</s:Group>
